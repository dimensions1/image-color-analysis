<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concentration Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        .image-container {
            width: 300px;
            height: 300px;
            margin: 20px;
            border: 1px solid #ccc;
        }
        img {
            max-width: 100%;
            max-height: 100%;
        }
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        h1, h2 {
            color: #333;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        #result {
            margin-top: 20px;
            font-size: 18px;
            color: #0066cc;
            font-weight: bold;
        }
        .guide {
            font-size: 14px;
            color: #666;
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .hint {
            font-style: italic;
            color: #888;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Concentration Calculator</h1>
    <div class="guide">
        <p><strong>Instructions:</strong></p>
        <p>For the <strong>Reference Photo</strong>: Upload a photo and crop or select the white area of the tape strip as accurately as possible. This provides the baseline color.</p>
        <p>For the <strong>Sample Photo</strong>: Upload a photo and crop or select the uniformly colored part as precisely as possible to ensure accurate analysis.</p>
        <p>After uploading and cropping both photos, click "Calculate Concentration" to see the result.</p>
    </div>

    <div>
        <h2>Reference Photo <span class="hint">(Select white area of tape strip)</span></h2>
        <input type="file" id="referenceInput" accept="image/*">
        <div class="image-container">
            <img id="referenceImg" style="display:none;">
        </div>
    </div>
    <div>
        <h2>Sample Photo <span class="hint">(Select uniformly colored part precisely)</span></h2>
        <input type="file" id="sampleInput" accept="image/*">
        <div class="image-container">
            <img id="sampleImg" style="display:none;">
        </div>
    </div>
    <button id="calculateBtn">Calculate Concentration</button>
    <div id="result"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
        let sampleCropper, referenceCropper;

        // Handle image upload for sample
        document.getElementById('sampleInput').addEventListener('change', function(e) {
            handleImageUpload(e, 'sampleImg', function(img) {
                if (sampleCropper) {
                    sampleCropper.destroy();
                }
                sampleCropper = new Cropper(img, {
                    aspectRatio: 1,
                    viewMode: 1,
                });
            });
        });

        // Handle image upload for reference
        document.getElementById('referenceInput').addEventListener('change', function(e) {
            handleImageUpload(e, 'referenceImg', function(img) {
                if (referenceCropper) {
                    referenceCropper.destroy();
                }
                referenceCropper = new Cropper(img, {
                    aspectRatio: 1,
                    viewMode: 1,
                });
            });
        });

        // Function to process uploaded image
        function handleImageUpload(event, imgId, callback) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = document.getElementById(imgId);
                img.src = event.target.result;
                img.style.display = 'block';
                img.onload = function() {
                    callback(img);
                };
            };
            reader.readAsDataURL(file);
        }

        // Calculate concentration when button is clicked
        document.getElementById('calculateBtn').addEventListener('click', function() {
            if (!sampleCropper || !referenceCropper) {
                alert('Please upload and crop both the sample and reference photos.');
                return;
            }

            const sampleCanvas = sampleCropper.getCroppedCanvas();
            const referenceCanvas = referenceCropper.getCroppedCanvas();

            if (!sampleCanvas || !referenceCanvas) {
                alert('Please crop both photos before calculating.');
                return;
            }

            const sampleAvg = calculateAverageRGB(sampleCanvas);
            const referenceAvg = calculateAverageRGB(referenceCanvas);

            // Reference - sample
            const diffR = referenceAvg.r - sampleAvg.r;
            const diffG = referenceAvg.g - sampleAvg.g;
            const diffB = referenceAvg.b - sampleAvg.b;

            const hue = rgbToHue(diffR, diffG, diffB);
            const concentration = -0.0133 * hue + 3.2495;

            // Display result with message and units
            document.getElementById('result').innerText = `Sodium Bicarbonate contamination detected!\nConcentration: ${concentration.toFixed(4)} %w/v`;
        });

        // Calculate average RGB values from a canvas
        function calculateAverageRGB(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let rSum = 0, gSum = 0, bSum = 0;
            let count = 0;

            for (let i = 0; i < data.length; i += 4) {
                rSum += data[i];     // Red
                gSum += data[i + 1]; // Green
                bSum += data[i + 2]; // Blue
                count++;
            }

            return {
                r: Math.round(rSum / count),
                g: Math.round(gSum / count),
                b: Math.round(bSum / count)
            };
        }

        // Convert RGB to Hue using the provided formula
        function rgbToHue(r, g, b) {
            const rPrime = r / 255;
            const gPrime = g / 255;
            const bPrime = b / 255;

            const cMax = Math.max(rPrime, gPrime, bPrime);
            const cMin = Math.min(rPrime, gPrime, bPrime);
            const delta = cMax - cMin;

            let hue;
            if (delta === 0) {
                hue = 0;
            } else if (cMax === rPrime) {
                hue = 60 * (((gPrime - bPrime) / delta) % 6);
            } else if (cMax === gPrime) {
                hue = 60 * ((bPrime - rPrime) / delta + 2);
            } else if (cMax === bPrime) {
                hue = 60 * ((rPrime - gPrime) / delta + 4);
            }

            if (hue < 0) {
                hue += 360;
            }

            return hue;
        }
    </script>
</body>
</html>
