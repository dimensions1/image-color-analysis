<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Concentration Calculator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css"/>
  <style>
    .image-container {
      width: 300px;
      height: 300px;
      margin: 20px auto;
      border: 1px solid #ccc;
    }
    img {
      max-width: 100%;
      max-height: 100%;
    }
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    h1, h2 {
      color: #333;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
    }
    #result {
      margin-top: 20px;
      font-size: 18px;
      color: #0066cc;
      font-weight: bold;
    }
    .guide {
      font-size: 14px;
      color: #666;
      margin: 10px 0;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 5px;
    }
    .hint {
      font-style: italic;
      color: #888;
      font-size: 12px;
    }
    .test-type {
      margin: 15px 0;
    }
    .test-type label {
      margin: 0 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Concentration Calculator</h1>
  <div class="guide">
    <p><strong>Instructions:</strong></p>
    <p><strong>Reference Photo (In case of Test Tube Testing):</strong> Upload and crop the white area of the tape strip to provide a baseline color. If you skip this, a default black reference will be used.</p>
    <p><strong>Sample Photo:</strong> Upload and crop the uniformly colored part for accurate analysis.</p>
    <p>Click "Calculate Concentration" after cropping both (or just the sample).</p>
  </div>

  <div class="test-type">
    <label><input type="radio" name="testType" value="tube" checked> Test Tube Testing</label>
    <label><input type="radio" name="testType" value="substrate"> Substrate Testing</label>
  </div>

  <div id="referenceSection" style="display:none;">
    <h2>Reference Photo</h2>
    <input type="file" id="referenceInput" accept="image/*">
    <div class="image-container">
      <img id="referenceImg" style="display:none;">
    </div>
  </div>

  <div>
    <h2>Sample Photo</h2>
    <input type="file" id="sampleInput" accept="image/*">
    <div class="image-container">
      <img id="sampleImg" style="display:none;">
    </div>
  </div>

  <button id="calculateBtn">Calculate Concentration</button>
  <div id="result"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <script>
    let sampleCropper, referenceCropper;

    // Image upload handler
    function handleImageUpload(event, imgId, callback) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        const img = document.getElementById(imgId);
        img.src = event.target.result;
        img.style.display = 'block';
        img.onload = function () {
          callback(img);
        };
      };
      reader.readAsDataURL(file);
    }

    // Image upload events
    document.getElementById('sampleInput').addEventListener('change', function (e) {
      handleImageUpload(e, 'sampleImg', function (img) {
        if (sampleCropper) sampleCropper.destroy();
        sampleCropper = new Cropper(img, {
          aspectRatio: 1,
          viewMode: 1,
        });
      });
    });

    document.getElementById('referenceInput').addEventListener('change', function (e) {
      handleImageUpload(e, 'referenceImg', function (img) {
        if (referenceCropper) referenceCropper.destroy();
        referenceCropper = new Cropper(img, {
          aspectRatio: 1,
          viewMode: 1,
        });
      });
    });

    // Calculate button click
    document.getElementById('calculateBtn').addEventListener('click', function () {
      if (!sampleCropper) {
        alert('Please upload and crop the sample photo.');
        return;
      }

      const sampleCanvas = sampleCropper.getCroppedCanvas();
      const sampleAvg = calculateAverageRGB(sampleCanvas);

      let referenceAvg;
      if (referenceCropper && document.querySelector('input[name="testType"]:checked').value === 'substrate') {
        const referenceCanvas = referenceCropper.getCroppedCanvas();
        referenceAvg = calculateAverageRGB(referenceCanvas);
      } else {
        referenceAvg = { r: 0, g: 0, b: 0 }; // Default to black
      }

      const diffR = referenceAvg.r - sampleAvg.r;
      const diffG = referenceAvg.g - sampleAvg.g;
      const diffB = referenceAvg.b - sampleAvg.b;

      const hue = rgbToHue(diffR, diffG, diffB);
      const concentration = -0.0133 * hue + 3.2495;

      document.getElementById('result').innerText =
        `Sodium Bicarbonate contamination detected!\nConcentration: ${concentration.toFixed(4)} %w/v`;
    });

    // Average RGB from canvas
    function calculateAverageRGB(canvas) {
      const ctx = canvas.getContext('2d');
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      let rSum = 0, gSum = 0, bSum = 0, count = 0;

      for (let i = 0; i < data.length; i += 4) {
        rSum += data[i];
        gSum += data[i + 1];
        bSum += data[i + 2];
        count++;
      }

      return {
        r: Math.round(rSum / count),
        g: Math.round(gSum / count),
        b: Math.round(bSum / count),
      };
    }

    // RGB to Hue
    function rgbToHue(r, g, b) {
      const rPrime = r / 255;
      const gPrime = g / 255;
      const bPrime = b / 255;

      const cMax = Math.max(rPrime, gPrime, bPrime);
      const cMin = Math.min(rPrime, gPrime, bPrime);
      const delta = cMax - cMin;

      let hue = 0;
      if (delta !== 0) {
        if (cMax === rPrime) {
          hue = 60 * (((gPrime - bPrime) / delta) % 6);
        } else if (cMax === gPrime) {
          hue = 60 * ((bPrime - rPrime) / delta + 2);
        } else {
          hue = 60 * ((rPrime - gPrime) / delta + 4);
        }
        if (hue < 0) hue += 360;
      }
      return hue;
    }

    // Toggle reference section
    document.querySelectorAll('input[name="testType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const referenceSection = document.getElementById('referenceSection');
        if (this.value === 'substrate') {
          referenceSection.style.display = 'block';
        } else {
          referenceSection.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
